stages:
  - test
  - mirror

test:
  stage: test
  image: golang:1.25.4
  script:
    - go test -v -race -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
  allow_failure: true # temporary
  rules:
    - when: never

mirror-to-github:
  stage: mirror
  before_script:
  - apt-get update && apt-get install -y gnupg
  - mkdir -p ~/.gnupg && chmod 700 ~/.gnupg
  - echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
  - echo "$GPG_PRIVATE_KEY" | base64 -d | gpg --batch --yes --import

  # gpg wrapper for git
  - echo '#!/bin/sh' > /usr/local/bin/gpg-ci
  - echo 'exec gpg --batch --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" "$@"' >> /usr/local/bin/gpg-ci
  - chmod +x /usr/local/bin/gpg-ci

  - git config gpg.program /usr/local/bin/gpg-ci
  - git config user.email "${GITHUB_USER_EMAIL}"
  - git config user.name "${GITHUB_USER_NAME}"
  - git config user.signingkey "${GPG_KEY_ID}"
  - git config commit.gpgsign true
  script:
    - git checkout -B master "$CI_COMMIT_SHA"
    # Remplacer dans go.mod
    - sed -i 's|gitlab.com/singfield/voting-app|github.com/73NN0/voting-app|g' go.mod
    # Remplacer dans tous les fichiers .go
    - find . -name "*.go" -type f -exec sed -i 's|gitlab.com/singfield/voting-app|github.com/73NN0/voting-app|g' {} +
    # Commit sign√© et push
    - git add .
    - git commit --amend --reset-author --no-edit -S  # -S force la signature
    - git remote add github https://${GITHUB_TOKEN}@github.com/73NN0/voting-app.git || true
    - git fetch github || true
    - git push github master:master --force-with-lease
    - git push github --tags --force-with-lease || true
  only:
    - master